                 
<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
    
    <head>
        <title>
            CubicVR.js: Bowling game - initial testing, SPACE = reset ball, R = reset pins
        </title>
        <script src="libs/ammo.js" type="text/javascript">
                
        </script>
        <script src="libs/CubicVR.js" type="text/javascript">
                
        </script>
        <script type='text/javascript'>
 			function SceneLoader(sceneFile) {
                this.shape = null;
                this.body = null;
                this.scene = CubicVR.loadCollada(sceneFile,"./images/");
				this.pinShape = null;
            }
            
            SceneLoader.prototype = {
                setupRigidBody: function(physics) {
                   	var i;
                    var sceneObjs = this.scene.sceneObjects;

                    this.shape = new CubicVR.CollisionMap();
                    this.pinShape = new CubicVR.CollisionMap();

                    for (i = 0; i < sceneObjs.length; i++) {
                        var sceneObj = sceneObjs[i];
                        var objMesh = sceneObj.getMesh();

                        if (objMesh) {
                            if (objMesh.name === "CollisionCube-mesh") {
								if (sceneObj.name.substr(0,7) === "pinBody") {
									this.pinShape.addShape({
									    type: "cylinder",
									    size: sceneObj.scale,
									    position: CubicVR.vec3.subtract(sceneObj.position,[0,0.580,0])
									});

									this.scene.removeSceneObject(sceneObj);
		                            i--;
								} else {			
		                            var body = new CubicVR.RigidBody(sceneObj,{
		                                type: "static",
		                                mass: 0,
		                                margin: 0,
		                                collision: {
		                                    type: "box",
		                                    size: sceneObj.scale
		                                }
		                            });

		                            physics.bind(body);
		                            this.scene.removeSceneObject(sceneObj);
		                            i--;
								}
                            }
                        }
                        if (objMesh.name === "BowlingBall-mesh") {
							var body = new CubicVR.RigidBody(sceneObj,{
		                                type: "dynamic",
		                                mass: 6.5,
		                                margin: 0,
		                                collision: {
		                                    type: "sphere",
		                                    radius: sceneObj.scale[0]/2
		                                }
		                            });

		                            physics.bind(body);
						}
                        if (sceneObj.name === "LaneModel") {
							sceneObj.shadowCast = false;
						}
                   }

					
					for (i = 1; i <= 10; i++) {
						var pin = new CubicVR.RigidBody(this.scene.getSceneObject("Pin_"+i),{
				                        type: "dynamic",
				                        mass: 1.5310,
				                        margin: 0,
				                        collision: this.pinShape
				                    });

				        physics.bind(pin);
	   				}
                },              
                getScene: function() {
                  return this.scene;
                }
            }

          
            function webGLStart() {
                // by default generate a full screen canvas with automatic resize
                var gl = CubicVR.init();
                var canvas = CubicVR.getCanvas();

                if (!gl) {
                    alert("Sorry, no WebGL support.");
                    return;
                };

                // New scene with our canvas dimensions and default camera with FOV 80
                //var scene = new CubicVR.Scene(canvas.width, canvas.height, 80);
				var loader = new SceneLoader("models/bowling.dae");
				scene = loader.getScene();
				scene.lights = [];

				var camStartPos = scene.camera.position.slice(0);
				scene.camera.resize(canvas.width,canvas.height);
				scene.camera.setTargeted(true);

                 // Create a shadowed area light, map resolution 2048
                scene.bindLight(new CubicVR.Light({
                  type:CubicVR.enums.light.type.AREA,
                  intensity:1.1,
				  specular:[1,1,1],
                  mapRes:2048,  // 4096 ? 8192 ? ;)
                  areaCeiling:10,
                  areaFloor:-10,
                  areaAxis: [15,-4], // specified in degrees east/west north/south
                  distance: 30
                }));
                
                CubicVR.setSoftShadows(true);
                
                   // init physics manager
                var physics = new CubicVR.ScenePhysics();

				loader.setupRigidBody(physics);				

                // initialize a mouse view controller
                mvc = new CubicVR.MouseViewController(canvas, scene.camera);

                // Add our scene to the window resize list
                CubicVR.addResizeable(scene);

	
                var pickConstraint = null;
                var pickDist = 0;
				var rigidBall = null;             

                 mvc.setEvents({
                    mouseMove: function (ctx, mpos, mdelta, keyState) {
                    
                        if (!ctx.mdown) return;

                        if (pickConstraint) {
                            pickConstraint.setPosition(scene.camera.unProject(mpos[0],mpos[1],pickDist));
                        } else {                   
                            ctx.orbitView(mdelta);
                        }
                        //          ctx.panView(mdelta);
                    },
                    mouseWheel: function (ctx, mpos, wdelta, keyState) {
                        ctx.zoomView(wdelta);
                    },
                    mouseDown: function (ctx, mpos, keyState) {
                      var rayTo = scene.camera.unProject(mpos[0],mpos[1]);
                      var result = physics.getRayHit(scene.camera.position,rayTo);

                      if (result && !pickConstraint) {
						var resultName = result.rigidBody.getSceneObject().name;

						if (resultName == "BowlingBall") {
							result.rigidBody.activate();
							var camVec = CubicVR.vec3.subtract(result.rigidBody.getSceneObject().position,scene.camera.position);
							camVec = CubicVR.vec3.multiply(CubicVR.vec3.normalize(camVec),50);
							
							result.rigidBody.applyImpulse(camVec,result.localPosition);

							rigidBall = result.rigidBody;
						} else {			
		                    pickConstraint = new CubicVR.Constraint({
		                        type: CubicVR.enums.physics.constraint.P2P,
		                        rigidBody: result.rigidBody,
		                        positionA: result.localPosition
		                    });                        
		                    
		                    physics.addConstraint(pickConstraint);                       
		                    pickDist = CubicVR.vec3.length(CubicVR.vec3.subtract(scene.camera.position,result.position));                        
		                    pickConstraint.setPosition(scene.camera.unProject(mpos[0],mpos[1],pickDist));
						}
                      }
                      
                    },
                    mouseUp: function(ctx, mpos, keyState) {
                        if (pickConstraint) {
                            physics.removeConstraint(pickConstraint);
                            pickConstraint = null;
                        }                        
                    },
                    keyDown: function(ctx, mpos, key, keyState) {
						if (key == CubicVR.keyboard.SPACE && rigidBall) {
							scene.camera.position = camStartPos.slice(0);
							rigidBall.reset();
						} else if (key == CubicVR.keyboard.KEY_R && rigidBall) {
							doReset = true;
						}
					},
                    keyUp: null
                });
                
                
				var doReset = false;

				var bowlingBall = this.scene.getSceneObject("BowlingBall");
             
                // Start our main drawing loop, it provides a timer and the gl context as parameters
                CubicVR.MainLoop(function(timer, gl) {
                    var seconds = timer.getSeconds();
					var lus = timer.getLastUpdateSeconds();

					if (doReset) {
						physics.reset(); 
						scene.camera.position = camStartPos.slice(0);
						doReset = false;
					}

                    physics.stepSimulation(lus);

                    scene.render();
					if (bowlingBall.position[2] > -12) {
						scene.camera.trackTarget(bowlingBall.position,lus*3.0,3.5);
						scene.camera.target = bowlingBall.position.slice(0);
					}

					if (scene.camera.position[1] < 0.5) {
						scene.camera.position[1] = 0.5;
					}
                });
            }
        </script>
    </head>
    
    <body onLoad="webGLStart();">
    </body>

</html>                 
